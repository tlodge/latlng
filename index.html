<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Maps JavaScript API Example: Editable Polylines</title>
     <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?libraries=drawing&key=AIzaSyCIwTY8WHSNHiwjFsoxA0v4gTKolhyFGb8&sensor=false">
    </script>

<script type="text/javascript">
  var poly, map;
  var markers = [];
  var path = new google.maps.MVCArray;
  var polys = [];
  
  function initialize() {
    var wb = new google.maps.LatLng(52.923023, -1.12133);
    
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 14,
      center: wb,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    
    
    var drawingManager = new google.maps.drawing.DrawingManager({
      drawingMode: google.maps.drawing.OverlayType.MARKER,
      drawingControl: true,
      drawingControlOptions: {
        position: google.maps.ControlPosition.TOP_CENTER,
        drawingModes: [
          google.maps.drawing.OverlayType.MARKER,
          google.maps.drawing.OverlayType.CIRCLE,
          google.maps.drawing.OverlayType.POLYGON,
          google.maps.drawing.OverlayType.POLYLINE,
          google.maps.drawing.OverlayType.RECTANGLE
        ]
      },
      markerOptions: {
        
      },
      circleOptions: {
        fillColor: '#ffff00',
        fillOpacity: 1,
        strokeWeight: 5,
        clickable: false,
        zIndex: 1,
        editable: true
      }
    });


    google.maps.event.addListener(drawingManager, 'polylinecomplete', function(polyline){
        if (markers[0]){
            mpos = markers[0].getPosition();
            lat1 = polyline.getPath().getAt(0).lat();
            lat2 = polyline.getPath().getAt(1).lat();
            lng1 = polyline.getPath().getAt(0).lng();
            lng2 = polyline.getPath().getAt(1).lng();
            console.log(_calculatedistance(lat1, mpos.lat(), lng1, mpos.lng()));
            console.log(_calculatedistance(lat2, mpos.lat(), lng2, mpos.lng()));
            console.log(_calculatecrosstrack(lat1, lat2, lng1, lng2, mpos.lat(), mpos.lng()));
        }
    });
    
    google.maps.event.addListener(drawingManager, 'markercomplete', function(marker){
        console.log("created a marker!");
        markers.push(marker);
        console.log(marker);
        if (markers[0] && markers[1]){
            m1 = markers[0].getPosition();
            m2 = markers[markers.length-1].getPosition();
            dist = _calculatedistance(m1.lat(), m2.lat(), m1.lng(), m2.lng());
            console.log("distance is " + dist); 
        }
       
        /*if (polys[0]){
             calculateshortestpath();
        }else{
            console.log("no calculation!");
        }*/
    });

    google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon){
        polys.push(polygon);
        console.log(polys);
        polygon.setEditable(true);
        
        if (markers[0]){
            calculateshortestpath();
        }else{
            console.log("no calculation!");
        }
    });
    
    function calculateshortestpath(){
        console.log("CALCULATING!!");
        markers[0].setIcon({path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW});
        
        var polygonBounds = polys[0].getPath();
        var firstcoord;
        
        polygonBounds.forEach(function(xy, i){
            
            if (i == 0){
                firstcoord = xy;
            }
            if (i > 0){
                console.log(xy.lat() + " " + xy.lng());
                mpos = markers[0].getPosition();
                console.log("from " + (i-1) + " to " + i);
                ct = _calculatecrosstrack(lastcoord.lat(), xy.lat(), lastcoord.lng(), xy.lng(), mpos.lat(), mpos.lng());
                console.log(ct);
            }
            lastcoord = xy;
        });
         //do the last calculation here;
         console.log("from last to first");
         ct = _calculatecrosstrack(lastcoord.lat(), firstcoord.lat(), lastcoord.lng(), firstcoord.lng(), mpos.lat(), mpos.lng());
        console.log(ct);
    }
    
    function _calculatecrosstrack(lat1, lat2, lng1, lng2, lat3, lng3){
        d13 = _calculatedistance(lat1, lat3, lng1, lng3);
        o13  = _calculatebearing(lat1, lat3, lng1, lng3);
        o12  = _calculatebearing(lat1, lat2, lng1, lng2);
        R = 6371;
        dxt = Math.asin(Math.sin(d13/R) * Math.sin(o13-o12)) * R;
       
        return dxt;
    }
    
    function radians(d){
        return d * Math.PI / 180;
    }
    
    function degrees(r){
        return r * 180 / Math.PI;
    }
    
    function _calculatedistance(lat1, lat2, lng1, lng2){
        R = 6371;
        dLat = radians(lat2 - lat1);
        dLon = radians(lng2 - lng1);
        lat1 = radians(lat1);
        lat2 = radians(lat2);
        
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;  
    }
    
    function _calculatebearing(lat1, lat2, lng1, lng2){
        dLon = radians(lng2 - lng1);
        lat1 = radians(lat1);
        lat2 = radians(lat2);
        y = Math.sin(dLon) * Math.cos(lat2);
        x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
        //brng = degrees(Math.atan2(y,x));
        brng = Math.atan2(y,x);
        return brng;
    }
    
    drawingManager.setMap(map);
}

   /* poly = new google.maps.Polygon({
      strokeWeight: 3,
      fillColor: '#5555FF'
    });
    poly.setMap(map);
    poly.setPaths(new google.maps.MVCArray([path]));

    google.maps.event.addListener(map, 'click', addPoint);
  }

  function addPoint(event) {
    path.insertAt(path.length, event.latLng);

    var marker = new google.maps.Marker({
      position: event.latLng,
      map: map,
      draggable: true
    });
    markers.push(marker);
    marker.setTitle("#" + path.length);

    google.maps.event.addListener(marker, 'click', function() {
      marker.setMap(null);
      for (var i = 0, I = markers.length; i < I && markers[i] != marker; ++i);
      markers.splice(i, 1);
      path.removeAt(i);
      }
    );

    google.maps.event.addListener(marker, 'dragend', function() {
      for (var i = 0, I = markers.length; i < I && markers[i] != marker; ++i);
      path.setAt(i, marker.getPosition());
      }
    );
  }*/
</script>




</head>
<body style="margin:0px; padding:0px;" onload="initialize()">
  <p>Instructions:
  <ul>
    <li>Click on the map to insert a vertex.</li>
    <li>Click on a vertex to remove it.</li>
    <li>Drag a vertex to move it.</li>
  </ul>
  </p>
  <div id="map" style="width: 980; height: 500;"></div>
</body>
</html>